#  Copyright ï¿½ Microsoft Corporation
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

# This template is responsible for detecting a service being alive.
steps:
  - task: AzureCLI@1
    retryCountOnTaskFailure: 1
    displayName: 'Helm Install ${{parameters.serviceName}}'
    condition: eq('${{ parameters.migrationCleanup }}', 'true')
    env:
      SERVICE_NAME: ${{parameters.serviceName}}
      BASE_NAME_RG: ${{parameters.baseResourceGroupName}}
      VALUES_FILE: ${{parameters.valuesFile}}
      CHART_PATH: ${{parameters.chartPath}}
      NAMESPACE: ${{parameters.namespace}}
      SKIP_CHECK: ${{parameters.skipCheck}}
    inputs:
      azureSubscription: '$(SERVICE_CONNECTION_NAME)'
      addSpnToEnvironment: true
      scriptLocation: inlineScript
      inlineScript: |
        #!/usr/bin/env bash
        set -euo pipefail

        echo "Logging in to AKS"
        echo "------------------------------------"
        sudo az aks install-cli
        AKS_NAME=$(az aks list --resource-group $BASE_NAME_RG-rg --query '[].{name:name}' -otsv)
        az aks get-credentials -g $BASE_NAME_RG-rg -n $AKS_NAME

        echo "Helm Source: $(HELM_SOURCE)"
        echo "Build Trigger Repo Name: $(Build.Repository.Name)"

        if [[ "$(HELM_SOURCE)" != "" ]]
        then
            HELM_SOURCE_NAME=$(HELM_SOURCE)
        else
            HELM_SOURCE_NAME=$(Build.Repository.Name)
        fi

        echo "Helm Source Name: $HELM_SOURCE_NAME"
        cd $(Agent.BuildDirectory)/s/$HELM_SOURCE_NAME

        cat $(Agent.BuildDirectory)/s/values.yaml

        echo "Building dependencies for chart"
        helm dependency build $CHART_PATH || echo "[WARN] Dependency build failed"

        echo "[INFO] Validating existing helm resources"
        if ! helm get notes $SERVICE_NAME --namespace $NAMESPACE; then
          echo "[WARNING] Release not found, migrating to helm install"
          echo "[WARNING] Deleting resources that will be created"
          helm template $SERVICE_NAME $CHART_PATH --namespace $NAMESPACE -f $(Agent.BuildDirectory)/s/values.yaml --output-dir /tmp/generated/ 
          for k8sman in $( find /tmp/generated/ -name "*.yml" -o -name "*.yaml"); do            
            kubectl delete -f $k8sman -n $NAMESPACE || echo "[INFO] Not found"
          done
        fi

        echo "Installing through helm"

        if [[ $SKIP_CHECK == true ]]
        then
            echo "***********************"
            echo "DEPLOY CHECK SKIPPED"
            echo "***********************"
            helm upgrade $SERVICE_NAME $CHART_PATH -f $(Agent.BuildDirectory)/s/values.yaml --namespace $NAMESPACE --install --create-namespace --debug --timeout 10m
            exit 0
        fi
        
        if [[ "$NAMESPACE" != "" ]]
        then
            helm upgrade $SERVICE_NAME $CHART_PATH -f $(Agent.BuildDirectory)/s/values.yaml --namespace $NAMESPACE --install --create-namespace --debug --wait --timeout 10m
        else
            helm upgrade $SERVICE_NAME $CHART_PATH -f $(Agent.BuildDirectory)/s/values.yaml --install --create-namespace --wait --debug --timeout 10m
        fi
